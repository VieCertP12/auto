<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>IPA Uploader Pro - VieCertP12</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: #1e1e1e; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #007aff; }
        .group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 14px; }
        input { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444; border-radius: 8px; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        button:hover { background: #005bb5; }
        #log { margin-top: 20px; padding: 12px; background: #000; color: #4af626; border-radius: 8px; font-family: monospace; font-size: 13px; height: 150px; overflow-y: auto; border: 1px solid #333; }
        .result { margin-top: 20px; padding: 15px; background: #e3f2fd; color: #333; border-radius: 8px; display: none; }
        .link { word-break: break-all; font-weight: bold; color: #d32f2f; background: #fff; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px dashed #007aff; }
    </style>
</head>
<body>

<div class="container">
    <h2>IPA & Plist Auto-Manager</h2>
    
    <div class="group">
        <label>1. GitHub Token (ghp_...):</label>
        <input type="password" id="token" placeholder="Dán mã Token vào đây">
    </div>

    <div class="group">
        <label>2. Tên miền (Ví dụ: sharechungchi.com):</label>
        <input type="text" id="domain" value="sharechungchi.com">
    </div>

    <div class="group">
        <label>3. Chọn file IPA & Tên Plist:</label>
        <input type="file" id="ipaFile" accept=".ipa" style="margin-bottom:10px;">
        <input type="text" id="plistName" placeholder="Tên file (ví dụ: esign123)">
    </div>

    <button id="btn" onclick="start()">BẮT ĐẦU UPLOAD 100%</button>

    <div id="log">Sẵn sàng chờ lệnh...</div>

    <div id="result" class="result">
        <strong>✅ THÀNH CÔNG! Link cài đặt iPhone:</strong>
        <div id="itms" class="link"></div>
        <button onclick="copy()" style="background:#28a745; padding:8px; font-size:12px;">Copy Link</button>
    </div>
</div>

<script>
    const OWNER = "VieCertP12";
    const REPO = "pageipa";

    function log(m) {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    }

    async function uploadToGithub(path, content, token, isBinary = false) {
        let sha = "";
        const check = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        if (check.ok) {
            const data = await check.json();
            sha = data.sha;
        }

        const body = {
            message: `Auto upload ${path}`,
            content: content,
            sha: sha || undefined
        };

        const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        return res;
    }

    async function start() {
        const token = document.getElementById('token').value.trim();
        const file = document.getElementById('ipaFile').files[0];
        const pName = document.getElementById('plistName').value.trim();
        const domain = document.getElementById('domain').value.trim();

        if (!token || !file || !pName) return alert("Thiếu thông tin!");
        document.getElementById('btn').disabled = true;

        try {
            log(`Bắt đầu xử lý: ${file.name}`);
            
            // 1. Đọc file IPA và chuyển sang Base64
            log("Đang mã hóa file IPA...");
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Ipa = reader.result.split(',')[1];
                
                // 2. Upload IPA vào folder 'ipas'
                log("Đang đẩy file IPA vào thư mục 'ipas'...");
                const ipaPath = `ipas/${file.name}`;
                const upIpa = await uploadToGithub(ipaPath, base64Ipa, token);
                
                if (!upIpa.ok) throw new Error("Không thể upload IPA.");
                log("Upload IPA thành công!");

                // 3. Tạo Plist
                log("Đang tạo file Plist...");
                const ipaUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${ipaPath}`;
                const plistContent = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict><key>items</key><array><dict><key>assets</key><array><dict><key>kind</key><string>software-package</string><key>url</key><string>${ipaUrl}</string></dict></array><key>metadata</key><dict><key>bundle-identifier</key><string>com.viecert.p12</string><key>bundle-version</key><string>1.0</string><key>kind</key><string>software</string><key>title</key><string>${pName}</string></dict></dict></array></dict></plist>`;

                // 4. Lưu Plist
                const plistPath = `esignplist/${pName}.plist`;
                const upPlist = await uploadToGithub(plistPath, btoa(unescape(encodeURIComponent(plistContent))), token);
                
                if (!upPlist.ok) throw new Error("Không thể lưu Plist.");
                log("Lưu Plist thành công!");

                // 5. Kết quả
                const finalPlistUrl = `https://${domain}/esignplist/${pName}.plist`;
                const itmsLink = `itms-services://?action=download-manifest&url=${finalPlistUrl}`;
                
                document.getElementById('itms').innerText = itmsLink;
                document.getElementById('result').style.display = 'block';
                log("--- HOÀN THÀNH 100% ---");
                document.getElementById('btn').disabled = false;
            };
        } catch (e) {
            log("LỖI: " + e.message);
            document.getElementById('btn').disabled = false;
        }
    }

    function copy() {
        navigator.clipboard.writeText(document.getElementById('itms').innerText);
        alert("Đã copy link cài đặt!");
    }
</script>
</body>
</html>
