<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>OTA Installer Generator - VieCertP12</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #fff; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: #2d2d2d; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #007aff; }
        .group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #bbb; }
        input, select { width: 100%; padding: 12px; background: #3d3d3d; border: 1px solid #555; border-radius: 8px; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #007aff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; transform: translateY(-2px); }
        #log { margin-top: 20px; padding: 15px; background: #000; color: #4af626; border-radius: 8px; font-family: monospace; font-size: 13px; height: 180px; overflow-y: auto; border: 1px solid #444; line-height: 1.5; }
        .result-area { margin-top: 25px; padding: 20px; background: #e8f2ff; color: #333; border-radius: 10px; display: none; border: 2px solid #007aff; }
        .link-text { word-break: break-all; font-weight: bold; color: #d32f2f; margin: 10px 0; padding: 10px; background: #fff; border-radius: 5px; border: 1px dashed #007aff; font-size: 14px; }
        .error-msg { color: #ff4d4d; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>IPA to OTA Link Generator</h2>

    <div class="group">
        <label>1. GitHub Token (ghp_...):</label>
        <input type="password" id="token" placeholder="Dán Token có quyền 'repo' vào đây">
        <button onclick="fetchReleases()" style="margin-top:10px; background:#444;">Tải danh sách Mục hiện có</button>
    </div>

    <div class="group">
        <label>2. Chọn Mục lưu IPA (Release Tag):</label>
        <select id="tagSelect" onchange="toggleTagInput()">
            <option value="">-- Bấm nút trên để tải --</option>
            <option value="NEW">+ Tạo mới Mục (Tag)...</option>
        </select>
        <input type="text" id="newTag" placeholder="Nhập tên Tag mới (ví dụ: v1.0)" style="display:none; margin-top:10px;">
    </div>

    <div class="group">
        <label>3. Tên miền hiển thị link Plist:</label>
        <input type="text" id="domain" value="sharechungchi.com">
    </div>

    <div class="group">
        <label>4. Chọn file IPA & Tên Plist:</label>
        <input type="file" id="ipaFile" accept=".ipa" style="margin-bottom:10px;">
        <input type="text" id="plistName" placeholder="Tên file lưu (ví dụ: es1)">
    </div>

    <button id="btnStart" onclick="execute()">BẮT ĐẦU QUY TRÌNH TỰ ĐỘNG</button>

    <div id="log">Sẵn sàng...</div>

    <div id="result" class="result-area">
        <strong>✅ THÀNH CÔNG! Link cài đặt cho iPhone:</strong>
        <div id="itmsLink" class="link-text"></div>
        <button onclick="copyLink()" style="background:#28a745;">Sao chép Link</button>
    </div>
</div>

<script>
    const OWNER = "VieCertP12";
    const REPO = "pageipa";

    function log(m, isError = false) {
        const l = document.getElementById('log');
        const colorClass = isError ? 'class="error-msg"' : '';
        l.innerHTML += `> <span ${colorClass}>${m}</span><br>`;
        l.scrollTop = l.scrollHeight;
    }

    function toggleTagInput() {
        const s = document.getElementById('tagSelect');
        document.getElementById('newTag').style.display = (s.value === 'NEW') ? 'block' : 'none';
    }

    async function fetchReleases() {
        const t = document.getElementById('token').value;
        if(!t) return alert("Vui lòng nhập Token!");
        log("Đang kết nối GitHub...");
        try {
            const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases`, {
                headers: { 'Authorization': `Bearer ${t.trim()}` }
            });
            if (!res.ok) throw new Error("Token sai hoặc không có quyền.");
            const data = await res.json();
            const sel = document.getElementById('tagSelect');
            sel.innerHTML = '<option value="">-- Chọn mục --</option><option value="NEW">+ Tạo mới Mục (Tag)...</option>';
            data.forEach(r => sel.innerHTML += `<option value="${r.tag_name}">Mục: ${r.tag_name}</option>`);
            log("Đã cập nhật danh sách Mục.");
        } catch(e) { log("Lỗi: " + e.message, true); }
    }

    async function execute() {
        const token = document.getElementById('token').value.trim();
        const file = document.getElementById('ipaFile').files[0];
        const pName = document.getElementById('plistName').value.trim();
        const domain = document.getElementById('domain').value.trim();
        let tag = document.getElementById('tagSelect').value;
        if(tag === 'NEW') tag = document.getElementById('newTag').value.trim();

        if(!token || !file || !tag || !pName) return alert("Thiếu thông tin!");

        document.getElementById('btnStart').disabled = true;
        document.getElementById('result').style.display = 'none';
        log(`--- Khởi động quy trình cho: ${pName} ---`);

        try {
            // 1. Kiểm tra Release
            log("Kiểm tra Mục (Tag)...");
            let relRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases/tags/${tag}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            let relData;
            if(relRes.status === 404) {
                log("Đang tạo Mục mới...");
                let createRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag_name: tag, name: `Release ${tag}` })
                });
                relData = await createRes.json();
            } else {
                relData = await relRes.json();
            }

            // 2. Upload IPA
            log(`Đang upload ${file.name} (vui lòng đợi)...`);
            const uploadUrl = `https://uploads.github.com/repos/${OWNER}/${REPO}/releases/${relData.id}/assets?name=${encodeURIComponent(file.name)}`;
            
            const upRes = await fetch(uploadUrl, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`, 
                    'Content-Type': 'application/octet-stream' 
                },
                body: file
            });

            if(!upRes.ok) {
                const err = await upRes.json();
                if(upRes.status === 422) throw new Error("File đã tồn tại trong Mục này. Hãy xóa trên GitHub hoặc đổi tên file.");
                throw new Error(err.message || "Lỗi upload IPA.");
            }
            
            const ipaUrl = `https://github.com/${OWNER}/${REPO}/releases/download/${tag}/${encodeURIComponent(file.name)}`;
            log("Upload IPA thành công!");

            // 3. Tạo Plist
            log("Đang cấu hình file Plist...");
            const plistBody = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0"><dict><key>items</key><array><dict><key>assets</key><array><dict><key>kind</key><string>software-package</string><key>url</key><string>${ipaUrl}</string></dict></array><key>metadata</key><dict><key>bundle-identifier</key><string>com.viecert.app</string><key>bundle-version</key><string>1.0</string><key>kind</key><string>software</string><key>title</key><string>${pName}</string></dict></dict></array></dict></plist>`;

            // 4. Lưu Plist (Có xử lý SHA để ghi đè)
            const path = `esignplist/${pName}.plist`;
            let sha = "";
            const checkRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(checkRes.ok) {
                const checkData = await checkRes.json();
                sha = checkData.sha;
                log("Tìm thấy file Plist cũ, đang cập nhật...");
            }

            const commitRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Auto update plist: ${pName}`,
                    content: btoa(unescape(encodeURIComponent(plistBody))),
                    sha: sha || undefined
                })
            });

            if(!commitRes.ok) throw new Error("Không thể lưu file Plist lên GitHub.");
            log("Đã lưu Plist thành công.");

            // 5. Kết quả
            const finalPlistUrl = `https://${domain}/esignplist/${pName}.plist`;
            const itms = `itms-services://?action=download-manifest&url=${finalPlistUrl}`;
            
            document.getElementById('itmsLink').innerText = itms;
            document.getElementById('result').style.display = 'block';
            log("--- TẤT CẢ HOÀN TẤT ---");

        } catch(e) {
            log("LỖI: " + e.message, true);
            console.error(e);
        } finally {
            document.getElementById('btnStart').disabled = false;
        }
    }

    function copyLink() {
        const text = document.getElementById('itmsLink').innerText;
        navigator.clipboard.writeText(text).then(() => alert("Đã copy link cài đặt!"));
    }
</script>
</body>
</html>
